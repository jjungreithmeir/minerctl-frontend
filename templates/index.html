{% extends "base.html" %}
{% block title_addition %} - firmware v{{ config.firmware_version }} {% endblock %}

{% block head %}
{{ JSGlue.include() }}
{% endblock %}

{% block content %}

{% if is_admin %}
<div class="right">
  <div class="row">
    <div class="right">
      <a class="waves-effect waves-light btn-small bg-color-main m-r-10 m-t-10" onclick="toggleEditMode()" id="edit-layout">edit layout</a>
      <a class="waves-effect waves-light btn-small bg-color-main m-r-10 m-t-10 d-none" onclick="toggleEditMode();saveLayout()" id="save-layout">save layout</a>
    </div>
    <div class="left">
      <a class="d-none waves-effect waves-light btn-small bg-color-red m-r-10 m-t-10 edit-mode" onclick="resetLayout()">cancel editing</a>
    </div>
  </div>
  <div class="edit-mode d-none row">
    <label for="number-racks">number of racks: </label><input class="input-number" id="number-racks" type="number" min="1" max="12" step="1" value="{{local_config.number_of_racks}}" onchange="updateRacks()" autocomplete="off"/>
  </div>
  <p class="d-none font-bold" id="overflow-warning">
    Only 10 rigs per rack are allowed!
  </p>
</div>
{% endif %}

<div class="row m-t-10">
  <div class="col 1">
    <div class="card">
      <div class="card-content">
        <span class="card-title"> temperature </span>
        <p> target: <span class="right">{{temp.target}} °C</span></p>
        <p> external reference: &nbsp; <span class="right">{{temp.external}} °C</span></p>
        <p> main sensor ID: <span class="right">#{{temp.sensor_id}}</span> </p>
        {% for key, value in temp.measurements.items() %}
        <p> sensor #{{key}}: <span class="right">{{value}} °C</span></p>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col 1">
    <div class="card">
      <div class="card-content">
        <span class="card-title"> filter
            {% if filter.status_ok %}
              <i class="material-icons right" title="filter does not need to be cleaned">check</i>
            {% else %}
              <i class="material-icons right blinking" title="CLEAN FILTER!">warning</i>
            {% endif %}
          </span>

        {% if not filter.status_ok %}
        <p class="font-bold">
          FILTER REQUIRES CLEANING!
        </p>
        {% endif %}
        <p> pressure difference: <span class="right"> &nbsp; {{filter.pressure_diff}} mBar </span></p>
        <p> pressure threshold: <span class="right"> {{filter.threshold}} mBar </span></p>
      </div>
    </div>
  </div>
  <div class="col 1">
    <div class="card">
      <div class="card-content">
        <span class="card-title"> fans </span>
        <p> min RPM:
          <span class="right">{{fans.min_rpm}}%&nbsp;
            </span>
        </p>
        <p> max RPM:
          <span class="right">{{fans.max_rpm}}%&nbsp;
            </span>
        </p>
        <p> current RPM:
          <span class="right">&nbsp;{{fans.rpm}}%&nbsp;
            </span>
        </p>
      </div>
    </div>
  </div>
  <div class="col 1">
    <div class="card">
      <div class="card-content">
        <span class="card-title"> operation </span>
        <p> mode: <span class="right">{{operation.active_mode}}</span></p>
      </div>
    </div>
  </div>
</div>

<div class="row flex">
  {% set cnt = [1] %}
  {% for row in range(local_config.number_of_racks) %}
  <div class="col 6 w-150px padder-5">

    <div class="bg-color-grey m-lr-2 padder rack" id="rack{{row}}">
      <p class="font-bold font-white font-large center-align no-margin rack-title"> rack {{ row + 1}} </p>

      {% for miner in range(10) %}
      <div class="h-rig m-b-5" id="rig_{{cnt[0] - 1}}">
        {% if miners.miners[cnt[0] - 1] or operation.active_mode == 'gpu' and miners.miners[cnt[0] - 1] != None %}
        <div class="bg-color-white z-depth-2 h-rig valign-wrapper padder-5 flex-sb" id="miner{{ cnt[0] }}">

        {% elif miners.miners[cnt[0] - 1] == False %}
        <div class="bg-color-white disabled-miner z-depth-2 h-rig valign-wrapper padder-5 flex-sb" id="miner{{ cnt[0] }}">

        {% else %}
        <div class="bg-color-white z-depth-2 h-rig valign-wrapper padder-5 flex-sb d-none placeholder-rig" id="placeholder{{ cnt[0] }}">
          <p class="color-grey fill-parent flex-text-center">
            placeholder
            <a class="right delete-rig pos-abs delete-btn d-none pointer" onclick="sendMinerAction({{cnt[0]}},'register')"><i title="add" class="material-icons color-main">add_circle</i></a>
          </p>

        </div>
        <div class="d-none z-depth-2 h-rig valign-wrapper padder-5 flex-sb" id="miner{{ cnt[0] }}">
        {% endif %}

          <p class="">
            #{{ cnt[0] }}
          </p>
          {% if operation.active_mode == 'fpga' %}
          <div class="switch">
            <label>
                  {% if miners.miners[cnt[0] - 1] %}
                    <input type="checkbox" class="miner-toggle" checked onclick="toggleMinerCSS('miner{{ cnt[0] }}');sendMinerAction({{cnt[0]}},'toggle')" id="miner{{ cnt[0] }}-checkbox" autocomplete="off">
                  {% else %}
                    <input type="checkbox" class="miner-toggle" id="miner{{ cnt[0] }}-checkbox" onclick="toggleMinerCSS('miner{{ cnt[0] }}');sendMinerAction({{cnt[0]}},'toggle')" id="miner{{ cnt[0] }}-checkbox" autocomplete="off">
                  {% endif %}
                  <span class="lever"></span>
                </label>
          </div>
          {% elif operation.active_mode == 'gpu' %}
          <div>
            <a class="waves-effect waves-light btn btn-tiny bg-color-main miner-btn" onclick="sendMinerAction({{cnt[0]}},'on')">ON</a>
            <a class="waves-effect waves-light btn btn-tiny bg-color-red miner-btn" onclick="sendMinerAction({{cnt[0]}},'off')">OFF</a>
          </div>
          {% endif %}
          {% if operation.active_mode == 'fpga' %}
          <a class="right"><i title="reset" class="material-icons color-black font-transparent pointer waves-effect" onclick="sendMinerAction({{cnt[0]}},'reset')">settings_backup_restore</i></a>
          {% endif %}
          <a class="right delete-rig pos-abs delete-btn d-none pointer" onclick="sendMinerAction({{cnt[0]}},'deregister')"><i title="delete" class="material-icons color-red">remove_circle</i></a>

        </div>
        </div>
        {% if cnt.append(cnt.pop() + 1) %}{% endif %}
        {% endfor %}

        </div>
      </div>
      {% endfor %}
    </div>

    <div id="cancel" class="modal">
      <div class="modal-content">
        <h4> Miner # </h4>
        <a href="#!" class="modal-close btn-flat">ON</a>
        <a href="#!" class="modal-close btn-flat">OFF</a>
        <a href="#!" class="modal-close btn-flat">RESET</a>
      </div>
    </div>

    {% endblock %}
    {% block scripts %}
    <script type="text/javascript">
      function toggleMinerCSS(selector) {
        $('#' + selector).toggleClass('disabled-miner', $('#' + selector + '-checkbox').val());
      }
      function removeMinerCSS(selector) {
        $('#' + selector).removeClass('disabled-miner', $('#' + selector + '-checkbox').val());
      }
      /** Dynamically removes .rack divs based on the number in the #number-rack input field. */
      function updateRacks() {
        $(".rack").each(function() {
          let id = parseInt(this.id.split('rack')[1])
          if (id >= $('#number-racks').val()) {
            $(this).addClass('d-none');
          } else {
            $(this).removeClass('d-none');
          }
        })
      }
      /** Sends an ajax PATCH request which is toggled by the miner buttons. */
      function sendMinerAction(id, action) {
        $.ajax({
          // -1 because the values start at 1 in the html elements
          url: Flask.url_for("action") + '?' + $.param({ action: action, id: id - 1 }),
          type: 'PATCH',
          dataType: 'json'
        });
        if (action == 'register' || action == 'deregister') {
          $("#miner" + id).toggleClass('d-none');
          $("#placeholder" + id).toggleClass('d-none');
        }
      }
      function toggleEditMode() {
        if ($('#save-layout').hasClass('d-none')) {
          $(".rack").sortable("enable");
          $('#edit-layout').toggleClass('d-none');
          $("#save-layout").toggleClass('d-none');
        } else {
          $('#edit-layout').toggleClass('d-none');
          $("#save-layout").toggleClass('d-none');
        }
        $('.h-rig').toggleClass('pointer');
        $('.edit-mode').toggleClass('d-none');
        $('.miner-btn').toggleClass('disabled');
        $(".placeholder-rig").toggleClass('d-none');
        $(".delete-rig").toggleClass('d-none');
        // inverts disabled prop
        $('.miner-toggle').prop('disabled', function(i, v) { return !v; });

        // If you uncomment the following line the rigs will wiggle if you enter
        // the edit mode, similiar to the IOS feature when you long-press an
        // app. It is disabled, however, because it needs a ton of resources.
        //$(".h-rig").toggleClass("wiggle")
      }
      function saveLayout() {
        let data = {'number_of_racks': $('#number-racks').val()}
        $.ajax({
          url: Flask.url_for("config"),
          type: 'PUT',
          dataType: 'json',
          data: data
        });

        // TODO fix this. somehow the flask app receives the entire json as a
        //single json attribute
        /*
        $(".rack").each(function() {
          layout[this.id] = $(this).sortable('toArray')
        })
        */
      }
      $(function() {
        $(".rack").sortable({
          connectWith: ".rack",
          items: "> .h-rig, > p:not(.rack-title)",
          receive: function(event, ui) {
            if ($(this).children().length > 11) {
              $('#save-layout').addClass('disabled');
              $('#overflow-warning').removeClass('d-none');
            } else {
              $('#save-layout').removeClass('disabled');
              $('#overflow-warning').addClass('d-none');
            }
          }
        });
        $(".rack").disableSelection();
        $(".rack").sortable("disable");
      });
    </script>
    {% endblock %}
